<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Coup Online</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
<style>
:root {
  --gold: #c9a84c; --gold-light: #f0d080; --gold-dark: #8a6a20;
  --bg-deep: #0a0608; --bg-card: #14090f; --bg-panel: #1a0f16; --bg-surface: #241520;
  --text-cream: #f5e8d0; --text-muted: #9a7a6a;
  --red: #cc3333; --green: #44cc77; --blue: #4488cc;
  --border: rgba(201,168,76,0.25);
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family:'Tajawal',sans-serif; background:var(--bg-deep); color:var(--text-cream);
  min-height:100vh; overflow-x:hidden;
}
body::before {
  content:''; position:fixed; inset:0; pointer-events:none; z-index:0;
  background:
    radial-gradient(ellipse at 15% 15%, rgba(139,26,26,0.07) 0%, transparent 50%),
    radial-gradient(ellipse at 85% 85%, rgba(201,168,76,0.05) 0%, transparent 50%);
}
.screen { display:none; min-height:100vh; position:relative; z-index:1; }
.screen.active { display:flex; flex-direction:column; }

#main-menu { align-items:center; justify-content:center; text-align:center; padding:2rem; gap:2rem; }
.game-title {
  font-family:'Cinzel Decorative',serif;
  font-size:clamp(3.5rem,12vw,7rem); font-weight:900; line-height:1;
  background:linear-gradient(135deg,var(--gold-dark),var(--gold-light),var(--gold-dark));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
  animation:shimmer 3s linear infinite; background-size:200%;
}
@keyframes shimmer { 0%{background-position:0%} 100%{background-position:200%} }
.game-subtitle { color:var(--text-muted); font-size:1.1rem; letter-spacing:0.3em; font-style:italic; margin-top:0.5rem; }
.divider { width:200px; height:2px; background:linear-gradient(90deg,transparent,var(--gold),transparent); margin:1rem auto; }

.menu-box {
  background:linear-gradient(135deg,var(--bg-panel),var(--bg-card));
  border:1px solid var(--border); border-radius:18px; padding:2rem;
  width:100%; max-width:480px;
  box-shadow:0 0 40px rgba(201,168,76,0.1), 0 20px 60px rgba(0,0,0,0.5);
}
.menu-btns { display:flex; flex-direction:column; gap:0.75rem; }

.about-section {
  background:var(--bg-surface); border:1px solid var(--border); border-radius:14px;
  padding:1.5rem; width:100%; max-width:600px; text-align:right;
}
.about-title { font-family:'Cinzel Decorative',serif; font-size:1.1rem; color:var(--gold); margin-bottom:1rem; }
.about-text { font-size:0.88rem; line-height:1.8; color:var(--text-muted); margin-bottom:0.75rem; }
.about-text strong { color:var(--text-cream); }
.about-list { margin:0.5rem 0 0.5rem 1.5rem; }
.about-list li { margin-bottom:0.4rem; }
.social-link {
  display:inline-flex; align-items:center; gap:0.5rem;
  color:var(--gold); text-decoration:none; font-size:0.9rem;
  transition:all 0.2s; margin-top:0.75rem;
}
.social-link:hover { color:var(--gold-light); transform:translateX(-3px); }

#settings-screen { align-items:center; justify-content:center; padding:2rem; gap:1rem; }
.settings-box {
  background:linear-gradient(135deg,var(--bg-panel),var(--bg-card));
  border:1px solid var(--border); border-radius:18px; padding:2rem;
  width:100%; max-width:440px;
}
.settings-title { font-family:'Cinzel Decorative',serif; font-size:1.1rem; color:var(--gold); margin-bottom:1.5rem; text-align:center; }
.setting-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.25rem; }
.setting-label { font-size:0.9rem; color:var(--text-cream); }
.volume-slider { flex:1; margin:0 1rem; height:4px; background:var(--bg-surface); border-radius:2px; appearance:none; }
.volume-slider::-webkit-slider-thumb { appearance:none; width:16px; height:16px; background:var(--gold); border-radius:50%; cursor:pointer; }
.volume-value { font-size:0.85rem; color:var(--gold); min-width:35px; text-align:left; }

#lobby { align-items:center; justify-content:center; text-align:center; padding:2rem; gap:1.5rem; }
.lobby-box {
  background:linear-gradient(135deg,var(--bg-panel),var(--bg-card));
  border:1px solid var(--border); border-radius:18px; padding:2rem;
  width:100%; max-width:440px;
  box-shadow:0 0 40px rgba(201,168,76,0.1), 0 20px 60px rgba(0,0,0,0.5);
}
.box-title { font-family:'Cinzel Decorative',serif; font-size:0.95rem; color:var(--gold); margin-bottom:1.25rem; letter-spacing:0.1em; }

.input-group { display:flex; flex-direction:column; gap:0.75rem; margin-bottom:1.25rem; }
.field-label { font-size:0.72rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.2em; margin-bottom:0.2rem; }
input[type=text] {
  background:var(--bg-surface); border:1px solid var(--border); border-radius:10px;
  padding:0.75rem 1rem; color:var(--text-cream); font-family:'Tajawal',sans-serif; font-size:1rem;
  outline:none; width:100%; transition:border-color 0.2s, box-shadow 0.2s; text-align:right;
}
input[type=text]:focus { border-color:var(--gold); box-shadow:0 0 0 3px rgba(201,168,76,0.12); }
input[type=text]::placeholder { color:var(--text-muted); }

.btn-primary {
  background:linear-gradient(135deg,var(--gold-dark),var(--gold),var(--gold-dark));
  background-size:200%; border:none; border-radius:12px; padding:0.9rem 2rem;
  color:var(--bg-deep); font-family:'Cinzel Decorative',serif; font-size:0.85rem; font-weight:700;
  cursor:pointer; transition:all 0.3s; letter-spacing:0.05em; width:100%;
}
.btn-primary:hover { background-position:right; transform:translateY(-2px); box-shadow:0 8px 25px rgba(201,168,76,0.4); }
.btn-primary:active { transform:translateY(0); }
.btn-primary:disabled { opacity:0.4; cursor:not-allowed; transform:none !important; }

.btn-secondary {
  background:var(--bg-surface); border:1px solid var(--border); border-radius:10px;
  padding:0.75rem 1.5rem; color:var(--text-cream); font-family:'Tajawal',sans-serif; font-size:0.9rem;
  cursor:pointer; transition:all 0.2s; width:100%;
}
.btn-secondary:hover { border-color:var(--gold); color:var(--gold); }

.or-divider { display:flex; align-items:center; gap:0.75rem; color:var(--text-muted); font-size:0.8rem; margin:0.5rem 0; }
.or-divider::before, .or-divider::after { content:''; flex:1; height:1px; background:var(--border); }

#waiting { align-items:center; justify-content:center; text-align:center; padding:2rem; gap:1.5rem; }
.room-code-display {
  background:linear-gradient(135deg,var(--bg-panel),var(--bg-card));
  border:2px solid var(--gold); border-radius:18px; padding:2rem;
  width:100%; max-width:440px;
  box-shadow:0 0 40px rgba(201,168,76,0.15);
}
.code-label { font-size:0.75rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.3em; margin-bottom:0.5rem; }
.code-value {
  font-family:'Cinzel Decorative',serif; font-size:3rem; letter-spacing:0.3em;
  background:linear-gradient(135deg,var(--gold-dark),var(--gold-light));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
  margin-bottom:0.5rem;
}
.code-hint { font-size:0.82rem; color:var(--text-muted); }

.players-waiting { width:100%; max-width:440px; }
.waiting-title { font-size:0.75rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.2em; margin-bottom:0.75rem; text-align:right; }
.waiting-list { display:flex; flex-direction:column; gap:0.5rem; }
.waiting-player {
  background:var(--bg-surface); border:1px solid var(--border); border-radius:10px;
  padding:0.75rem 1rem; display:flex; align-items:center; gap:0.75rem;
  animation:slideIn 0.3s ease;
}
@keyframes slideIn { from{opacity:0;transform:translateX(-15px)} to{opacity:1;transform:translateX(0)} }
.waiting-dot { width:8px; height:8px; background:var(--green); border-radius:50%; box-shadow:0 0 6px var(--green); }
.waiting-name { flex:1; font-size:0.95rem; }
.waiting-host { font-size:0.7rem; color:var(--gold); background:rgba(201,168,76,0.12); padding:2px 8px; border-radius:10px; }
.pulse { animation:pulse 1.5s ease-in-out infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

#game { padding:0.75rem; gap:0.75rem; }
.top-bar {
  display:flex; align-items:center; justify-content:space-between;
  background:linear-gradient(90deg,var(--bg-panel),var(--bg-card),var(--bg-panel));
  border:1px solid var(--border); border-radius:12px; padding:0.65rem 1rem;
}
.top-title { font-family:'Cinzel Decorative',serif; font-size:1rem; color:var(--gold); }
.top-info { font-size:0.8rem; color:var(--text-muted); }
.top-info span { color:var(--gold-light); font-weight:700; }

.my-hand {
  background:linear-gradient(135deg,var(--bg-panel),var(--bg-card));
  border:2px solid var(--gold); border-radius:14px; padding:1rem;
  box-shadow:0 0 20px rgba(201,168,76,0.08);
}
.hand-label { font-size:0.7rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.2em; margin-bottom:0.75rem; }
.hand-cards { display:flex; gap:0.75rem; flex-wrap:wrap; }

.hand-card {
  width:80px; height:110px; border-radius:10px; border:1.5px solid;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:4px; cursor:default; position:relative; transition:transform 0.2s; flex-shrink:0;
}
.hand-card:hover { transform:translateY(-4px); }
.hand-card .hc-icon { font-size:2rem; }
.hand-card .hc-name { font-size:0.65rem; font-weight:700; letter-spacing:0.05em; }
.hand-card.revealed { opacity:0.4; filter:grayscale(1); }
.hand-card.revealed::after { content:'âœ•'; position:absolute; top:4px; right:4px; font-size:0.7rem; color:var(--red); }

.others-area { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:0.6rem; }
.opp-card {
  background:linear-gradient(135deg,var(--bg-panel),var(--bg-card));
  border:1px solid var(--border); border-radius:12px; padding:0.9rem;
  transition:all 0.3s; position:relative; overflow:hidden;
}
.opp-card::before { content:''; position:absolute; top:0;left:0;right:0; height:3px; background:linear-gradient(90deg,var(--gold-dark),var(--gold)); opacity:0; transition:opacity 0.3s; }
.opp-card.active-turn { border-color:var(--gold); box-shadow:0 0 15px rgba(201,168,76,0.2); }
.opp-card.active-turn::before { opacity:1; }
.opp-card.eliminated { opacity:0.35; filter:grayscale(1); }
.opp-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:0.6rem; }
.opp-name { font-weight:700; font-size:0.9rem; }
.opp-coins { font-size:0.8rem; color:var(--gold); background:rgba(201,168,76,0.1); border-radius:20px; padding:2px 8px; }
.opp-cards-row { display:flex; gap:0.4rem; }
.mini-card {
  width:42px; height:58px; border-radius:6px; border:1px solid; display:flex;
  flex-direction:column; align-items:center; justify-content:center; font-size:0.5rem; font-weight:700;
}
.mini-card.face-down { background:linear-gradient(135deg,#1a0a20,#2a1030); border-color:rgba(201,168,76,0.3); }
.mini-card.face-down::after { content:'?'; font-family:'Cinzel Decorative',serif; font-size:1.2rem; color:rgba(201,168,76,0.3); }
.mini-card .mc-icon { font-size:1.1rem; margin-bottom:1px; }
.dead-badge { position:absolute; top:-1px; right:-1px; background:#8b1a1a; border-radius:0 6px 0 6px; padding:1px 4px; font-size:0.45rem; color:#ffa0a0; font-weight:700; }

.duke { background:linear-gradient(135deg,#3d1a6b,#5c2a9e); border-color:#7a44bb !important; color:#c9a0f0; }
.assassin { background:linear-gradient(135deg,#1a1a1a,#2d1a1a); border-color:#6b1a1a !important; color:#e06060; }
.ambassador { background:linear-gradient(135deg,#0a2a1a,#1a4a30); border-color:#2a7a4a !important; color:#80d4a0; }
.captain { background:linear-gradient(135deg,#0a1a3d,#1a3060); border-color:#2a50a0 !important; color:#70a0e0; }
.contessa { background:linear-gradient(135deg,#3d0a20,#601a35); border-color:#a02850 !important; color:#e080a0; }

.actions-panel {
  background:linear-gradient(135deg,var(--bg-panel),var(--bg-card));
  border:1px solid var(--border); border-radius:14px; padding:1rem;
}
.actions-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; padding-bottom:0.75rem; border-bottom:1px solid var(--border); }
.ah-left .ah-label { font-size:0.7rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.2em; }
.ah-left .ah-name { font-family:'Cinzel Decorative',serif; font-size:1rem; color:var(--gold-light); margin-top:2px; }
.ah-right .ah-label { font-size:0.7rem; color:var(--text-muted); text-align:left; }
.ah-right .ah-coins { font-family:'Cinzel Decorative',serif; font-size:1rem; color:var(--gold); }
.waiting-turn { text-align:center; padding:1.5rem; color:var(--text-muted); font-size:0.9rem; border:1px dashed var(--border); border-radius:10px; }
.waiting-turn .wt-name { color:var(--gold-light); font-weight:700; }
.actions-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:0.55rem; }
.action-btn {
  background:var(--bg-surface); border:1px solid var(--border); border-radius:10px;
  padding:0.7rem; cursor:pointer; transition:all 0.25s; text-align:right;
  font-family:'Tajawal',sans-serif; color:var(--text-cream); position:relative;
}
.action-btn:hover:not(:disabled) { transform:translateY(-2px); box-shadow:0 6px 20px rgba(0,0,0,0.3); }
.action-btn:disabled { opacity:0.3; cursor:not-allowed; }
.action-btn.income:hover:not(:disabled) { border-color:var(--green); color:var(--green); }
.action-btn.foreign-aid:hover:not(:disabled) { border-color:#70a0e0; color:#70a0e0; }
.action-btn.coup-action:hover:not(:disabled) { border-color:var(--red); color:var(--red); }
.action-btn.coup-action.required { border-color:var(--red); animation:pulseRed 1s infinite; }
.action-btn.duke-action:hover:not(:disabled) { border-color:#7a44bb; color:#c9a0f0; }
.action-btn.assassin-action:hover:not(:disabled) { border-color:#e06060; color:#e06060; }
.action-btn.captain-action:hover:not(:disabled) { border-color:#70a0e0; color:#70a0e0; }
.action-btn.ambassador-action:hover:not(:disabled) { border-color:#80d4a0; color:#80d4a0; }
@keyframes pulseRed { 0%,100%{box-shadow:0 0 0 0 rgba(204,51,51,0.3)} 50%{box-shadow:0 0 0 6px rgba(204,51,51,0)} }
.ab-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:0.25rem; }
.ab-name { font-size:0.9rem; font-weight:700; }
.ab-icon { font-size:1.25rem; }
.ab-cost { display:inline-flex; align-items:center; font-size:0.68rem; background:rgba(201,168,76,0.12); border-radius:10px; padding:1px 6px; color:var(--gold); margin-bottom:0.2rem; }
.ab-cost.gain { color:var(--green); background:rgba(68,204,119,0.1); }
.ab-desc { font-size:0.7rem; color:var(--text-muted); line-height:1.4; }
.target-area { margin-top:0.6rem; }
.target-box { background:var(--bg-surface); border:1px solid var(--border); border-radius:10px; padding:0.75rem; }
.target-label { font-size:0.72rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.15em; margin-bottom:0.5rem; }
.target-btns { display:flex; flex-wrap:wrap; gap:0.4rem; }
.target-btn {
  background:var(--bg-panel); border:1px solid var(--border); border-radius:8px;
  padding:0.4rem 0.9rem; font-family:'Tajawal',sans-serif; font-size:0.85rem;
  color:var(--text-cream); cursor:pointer; transition:all 0.2s;
}
.target-btn:hover { border-color:var(--red); color:var(--red); }

.log-panel { background:linear-gradient(135deg,var(--bg-panel),var(--bg-card)); border:1px solid var(--border); border-radius:12px; padding:0.9rem; max-height:180px; overflow-y:auto; }
.log-title { font-size:0.68rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.2em; margin-bottom:0.6rem; }
.log-entry { display:flex; gap:0.4rem; align-items:flex-start; padding:0.3rem 0; border-bottom:1px solid rgba(201,168,76,0.05); font-size:0.8rem; animation:fadeIn 0.3s ease; }
@keyframes fadeIn { from{opacity:0;transform:translateX(8px)} to{opacity:1;transform:translateX(0)} }
.log-t { color:var(--gold); font-size:0.68rem; min-width:18px; }
.log-m { color:var(--text-muted); line-height:1.5; }
.log-m .hl { color:var(--text-cream); }
.log-m .coin-c { color:var(--gold); }
.log-m .danger-c { color:var(--red); }
.log-m .ok-c { color:var(--green); }

.modal-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,0.88); display:flex;
  align-items:center; justify-content:center; z-index:100; padding:1rem;
  backdrop-filter:blur(4px); animation:fadeInModal 0.2s ease;
}
@keyframes fadeInModal { from{opacity:0} to{opacity:1} }
.modal {
  background:linear-gradient(135deg,var(--bg-panel),var(--bg-card));
  border:1px solid var(--gold); border-radius:18px; padding:1.75rem;
  width:100%; max-width:420px;
  box-shadow:0 0 60px rgba(201,168,76,0.2), 0 30px 80px rgba(0,0,0,0.5);
  animation:slideUp 0.3s ease; max-height:85vh; overflow-y:auto;
}
@keyframes slideUp { from{opacity:0;transform:translateY(20px) scale(0.96)} to{opacity:1;transform:translateY(0) scale(1)} }
.modal-title { font-family:'Cinzel Decorative',serif; font-size:1.05rem; color:var(--gold); margin-bottom:0.4rem; text-align:center; }
.modal-sub { font-size:0.82rem; color:var(--text-muted); text-align:center; margin-bottom:1.25rem; }
.modal-btns { display:flex; flex-direction:column; gap:0.55rem; }
.mbtn {
  background:var(--bg-surface); border:1px solid var(--border); border-radius:10px;
  padding:0.7rem 1rem; cursor:pointer; text-align:right; font-family:'Tajawal',sans-serif;
  color:var(--text-cream); transition:all 0.2s; display:flex; align-items:center; gap:0.6rem;
}
.mbtn:hover { border-color:var(--gold); background:rgba(201,168,76,0.07); }
.mbtn.danger:hover { border-color:var(--red); background:rgba(204,51,51,0.07); color:var(--red); }
.mbtn.confirm:hover { border-color:var(--green); background:rgba(68,204,119,0.07); color:var(--green); }
.mbtn .mi { font-size:1.25rem; }
.mbtn .mt { flex:1; }
.mbtn .mn { font-weight:700; font-size:0.9rem; }
.mbtn .md { font-size:0.72rem; color:var(--text-muted); margin-top:1px; }
.timer-bar { height:3px; background:var(--gold); border-radius:2px; margin-top:0.75rem; animation:timerShrink 10s linear; }
@keyframes timerShrink { from{width:100%} to{width:0%} }

.notif {
  position:fixed; top:1rem; left:50%; transform:translateX(-50%);
  background:linear-gradient(135deg,var(--bg-panel),var(--bg-surface));
  border:1px solid var(--gold); border-radius:10px; padding:0.7rem 1.5rem;
  font-size:0.85rem; color:var(--gold-light); z-index:200; white-space:nowrap;
  animation:notifIn 0.3s ease, notifOut 0.3s ease 2.5s forwards;
  box-shadow:0 10px 30px rgba(0,0,0,0.4);
}
@keyframes notifIn { from{opacity:0;transform:translateX(-50%) translateY(-15px)} to{opacity:1;transform:translateX(-50%) translateY(0)} }
@keyframes notifOut { to{opacity:0;transform:translateX(-50%) translateY(-10px)} }

#winner { align-items:center; justify-content:center; text-align:center; padding:2rem; gap:1.5rem; }
.winner-scene {
  position:relative; padding:3rem 2rem;
  background:linear-gradient(135deg,rgba(201,168,76,0.08),rgba(201,168,76,0.02));
  border:2px solid var(--gold); border-radius:20px;
  box-shadow:0 0 60px rgba(201,168,76,0.2);
  max-width:500px; width:100%;
}
.confetti { position:absolute; font-size:1.5rem; animation:confettiFall 3s linear infinite; }
.confetti:nth-child(1){left:10%;animation-delay:0s}
.confetti:nth-child(2){left:30%;animation-delay:0.5s}
.confetti:nth-child(3){left:50%;animation-delay:1s}
.confetti:nth-child(4){left:70%;animation-delay:1.5s}
.confetti:nth-child(5){left:90%;animation-delay:2s}
@keyframes confettiFall { 0%{top:-20px;opacity:1} 100%{top:100%;opacity:0} }
.winner-crown { font-size:5rem; animation:wBounce 1s ease-in-out infinite alternate; margin-bottom:1rem; }
@keyframes wBounce { from{transform:translateY(0) rotate(-5deg) scale(1)} to{transform:translateY(-15px) rotate(5deg) scale(1.08)} }
.winner-label { font-family:'Cinzel Decorative',serif; font-size:0.9rem; color:var(--text-muted); letter-spacing:0.25em; text-transform:uppercase; }
.winner-name {
  font-family:'Cinzel Decorative',serif; font-size:2.8rem;
  background:linear-gradient(135deg,var(--gold-dark),var(--gold-light),var(--gold-dark));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
  background-size:200%; animation:shimmer 2s linear infinite; margin:0.5rem 0 1.5rem;
}

.ref-panel { background:linear-gradient(135deg,var(--bg-panel),var(--bg-card)); border:1px solid var(--border); border-radius:12px; padding:0.9rem; }
.ref-label { font-size:0.68rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.2em; margin-bottom:0.6rem; }
.ref-row { display:flex; gap:0.4rem; flex-wrap:wrap; }
.ref-chip { flex:1; min-width:80px; border-radius:8px; border:1px solid; padding:0.45rem 0.5rem; font-size:0.68rem; cursor:pointer; transition:transform 0.2s; }
.ref-chip:hover { transform:scale(1.04); }
.ref-chip .rc-icon { font-size:1rem; margin-bottom:2px; }
.ref-chip .rc-name { font-weight:700; }
.ref-chip .rc-power { opacity:0.7; margin-top:1px; }

::-webkit-scrollbar { width:5px; }
::-webkit-scrollbar-track { background:var(--bg-deep); }
::-webkit-scrollbar-thumb { background:var(--gold-dark); border-radius:3px; }

@media(max-width:600px) {
  .others-area { grid-template-columns:1fr 1fr; }
  .actions-grid { grid-template-columns:1fr 1fr; }
}

/* â”€â”€ SPECTATOR BANNER â”€â”€ */
.spectator-banner {
  background: linear-gradient(135deg, rgba(139,26,26,0.3), rgba(80,10,10,0.5));
  border: 1px solid rgba(204,51,51,0.4);
  border-radius: 12px; padding: 0.85rem 1.2rem;
  display: flex; align-items: center; gap: 0.75rem;
  animation: specPulse 2s ease-in-out infinite;
}
@keyframes specPulse { 0%,100%{border-color:rgba(204,51,51,0.4)} 50%{border-color:rgba(204,51,51,0.8)} }
.spec-icon { font-size: 1.4rem; }
.spec-text { flex:1; }
.spec-title { font-weight:700; color:var(--red); font-size:0.95rem; }
.spec-sub { font-size:0.75rem; color:var(--text-muted); margin-top:2px; }

/* â”€â”€ PARTICLES â”€â”€ */
#particles-canvas {
  position:fixed; inset:0; pointer-events:none; z-index:0;
}

/* â”€â”€ CREDITS FOOTER â”€â”€ */
.credits-bar {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: linear-gradient(90deg, transparent, rgba(10,6,8,0.95), transparent);
  padding: 0.5rem 1rem;
  display: flex; align-items: center; justify-content: center; gap: 1rem;
  font-size: 0.7rem; color: var(--text-muted); z-index: 50;
  border-top: 1px solid rgba(201,168,76,0.08);
}
.credits-bar .cr-label { color: rgba(201,168,76,0.4); font-size: 0.62rem; letter-spacing:0.15em; text-transform:uppercase; }
.credits-bar .cr-name {
  color: var(--gold-dark); font-weight: 700; font-size: 0.72rem;
  transition: color 0.2s; cursor: default;
}
.credits-bar .cr-name:hover { color: var(--gold); }
.credits-bar .cr-sep { color: rgba(201,168,76,0.2); }

/* â”€â”€ SPLASH FX â”€â”€ */
.fx-splash {
  position: fixed; pointer-events:none; z-index:300;
  font-size: 2.5rem; animation: fxPop 0.8s ease forwards;
  transform-origin: center;
}
@keyframes fxPop {
  0%   { opacity:1; transform: scale(0.3) translateY(0); }
  50%  { opacity:1; transform: scale(1.4) translateY(-30px); }
  100% { opacity:0; transform: scale(1)   translateY(-80px); }
}

/* â”€â”€ COUP FLASH â”€â”€ */
.coup-flash {
  position:fixed; inset:0; background: rgba(204,51,51,0.15);
  pointer-events:none; z-index:290; animation: cFlash 0.5s ease forwards;
}
@keyframes cFlash { 0%{opacity:1} 100%{opacity:0} }
</style>
</head>
<body>

<canvas id="particles-canvas"></canvas>

<!-- MAIN MENU -->
<div id="main-menu" class="screen active">
  <div>
    <div class="game-title">COUP</div>
    <div class="game-subtitle">Ù„Ø¹Ø¨Ø© Ø§Ù„Ø®Ø¯Ø§Ø¹ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ</div>
  </div>
  <div class="divider"></div>
  <div class="menu-box">
    <div class="menu-btns">
      <button class="btn-primary" onclick="showScreen('lobby')">ğŸ® Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨</button>
      <button class="btn-secondary" onclick="showScreen('about')">ğŸ“– Ø¹Ù† Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
      <button class="btn-secondary" onclick="showScreen('settings-screen')">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>
  </div>
</div>

<!-- ABOUT -->
<div id="about" class="screen">
  <div style="align-items:center;justify-content:center;padding:2rem;gap:1.5rem;display:flex;flex-direction:column;width:100%">
    <div class="game-title" style="font-size:2.5rem">COUP</div>
    <div class="about-section">
      <div class="about-title">ğŸ­ Ù†Ø¨Ø°Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ø¹Ù† Ù„Ø¹Ø¨Ø© Coup</div>
      <div class="about-text"><strong>Coup</strong> Ù‡ÙŠ Ù„Ø¹Ø¨Ø© Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø¯Ø§Ø¹ØŒ Ø§Ù„Ø¥Ù‚Ù†Ø§Ø¹ØŒ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±ØŒ ØµØ¯Ø±Øª Ø¹Ø§Ù… 2012 Ù…Ù† ØªØ·ÙˆÙŠØ± Rikki Tahta ÙˆÙ†Ø´Ø± Ø´Ø±ÙƒØ© Indie Boards & Cards.</div>
      <div class="about-text">ØªØ¯ÙˆØ± Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù„Ø¹Ø¨Ø© ÙÙŠ Ø¹Ø§Ù„Ù… Ø¯ÙŠØ³ØªÙˆØ¨ÙŠ Ø®ÙŠØ§Ù„ÙŠ ØªØ³ÙŠØ·Ø± Ø¹Ù„ÙŠÙ‡ Ø·Ø¨Ù‚Ø© ÙØ§Ø³Ø¯Ø© Ù…Ù† Ø§Ù„Ù†Ø®Ø¨Ø©ØŒ Ø­ÙŠØ« ÙŠØ³Ø¹Ù‰ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† Ù„Ø¥Ø³Ù‚Ø§Ø· Ù†ÙÙˆØ° Ø®ØµÙˆÙ…Ù‡Ù… ÙˆØ§Ù„Ø³ÙŠØ·Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³Ù„Ø·Ø© Ø¹Ø¨Ø± Ø§Ù„Ù…Ø±Ø§ÙˆØºØ© Ø§Ù„Ø³ÙŠØ§Ø³ÙŠØ© ÙˆØ§Ù„Ø§Ø¯Ø¹Ø§Ø¡ Ø¨Ø§Ù…ØªÙ„Ø§Ùƒ Ø´Ø®ØµÙŠØ§Øª Ø°Ø§Øª Ù†ÙÙˆØ°.</div>
      <div class="about-title" style="font-size:0.95rem;margin-top:1.5rem">ğŸ® ÙÙƒØ±Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©</div>
      <div class="about-text">ÙƒÙ„ Ù„Ø§Ø¹Ø¨ ÙŠÙ…ØªÙ„Ùƒ Ø¨Ø·Ø§Ù‚ØªÙŠÙ† ØªÙ…Ø«Ù„Ø§Ù† Ø´Ø®ØµÙŠØ§Øª Ø³Ø±ÙŠØ© Ø°Ø§Øª Ù‚Ø¯Ø±Ø§Øª Ø®Ø§ØµØ©. Ù„Ø§ ÙŠÙØ´ØªØ±Ø· Ø£Ù† ÙŠÙ‚ÙˆÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø© â€” ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„Ø§Ø¯Ø¹Ø§Ø¡ Ø¨Ø§Ù…ØªÙ„Ø§Ùƒ Ø£ÙŠ Ø´Ø®ØµÙŠØ© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙŠØ²ØªÙ‡Ø§ØŒ Ù„ÙƒÙ† Ù…Ø¹ Ù…Ø®Ø§Ø·Ø±Ø© Ø£Ù† ÙŠØªØ­Ø¯Ø§Ù‡ Ù„Ø§Ø¹Ø¨ Ø¢Ø®Ø± ÙˆÙŠÙƒØ´Ù Ø®Ø¯Ø§Ø¹Ù‡.</div>
      <div class="about-title" style="font-size:0.95rem;margin-top:1.5rem">ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</div>
      <div class="about-text"><strong>2 â€“ 6 Ù„Ø§Ø¹Ø¨ÙŠÙ†</strong> Â· Ù…Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨: 10 â€“ 20 Ø¯Ù‚ÙŠÙ‚Ø© Â· Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¹Ù…Ø±ÙŠØ©: 13+</div>
      <div class="divider" style="margin:1.5rem auto"></div>
      <a href="https://guns.lol/sabrialharbi" target="_blank" class="social-link">ğŸ”— ØªÙˆØ§ØµÙ„ Ù…Ø¹ÙŠ: guns.lol/sabrialharbi</a>
    </div>
    <button class="btn-secondary" style="max-width:280px" onclick="showScreen('main-menu')">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
  </div>
</div>

<!-- SETTINGS -->
<div id="settings-screen" class="screen">
  <div style="width:100%;max-width:1200px;margin:0 auto;padding:2rem">
    <div class="game-title" style="font-size:2rem;text-align:center;margin-bottom:2rem">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
    <div class="settings-box">
      <div class="settings-title">ğŸ”Š Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ØµÙˆØª</div>
      <div class="setting-row">
        <div class="setting-label">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª</div>
        <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="70">
        <div class="volume-value" id="volume-value">70%</div>
      </div>
      <div style="text-align:center;color:var(--text-muted);font-size:0.8rem;margin-top:1rem">(Ø§Ù„Ø£ØµÙˆØ§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ± â€” Ù‚Ø±ÙŠØ¨Ù‹Ø§!)</div>
    </div>
    <button class="btn-secondary" style="max-width:280px;margin:2rem auto;display:block" onclick="showScreen('main-menu')">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
  </div>
</div>

<!-- LOBBY -->
<div id="lobby" class="screen">
  <div class="game-title" style="font-size:2.5rem">COUP</div>
  <div class="divider"></div>
  <div class="lobby-box">
    <div class="box-title">ğŸ® Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ©</div>
    <div class="input-group">
      <div>
        <div class="field-label">Ø§Ø³Ù…Ùƒ</div>
        <input type="text" id="player-name-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ..." maxlength="20">
      </div>
    </div>
    <button class="btn-primary" onclick="createRoom()">âœ¨ Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
    <div class="or-divider">Ø£Ùˆ</div>
    <div class="input-group">
      <div>
        <div class="field-label">ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©</div>
        <input type="text" id="room-code-input" placeholder="Ù…Ø«Ø§Ù„: XKQM" maxlength="4"
          style="text-align:center;letter-spacing:0.4em;font-family:'Cinzel Decorative',serif;font-size:1.5rem;text-transform:uppercase">
      </div>
    </div>
    <button class="btn-secondary" onclick="joinRoom()">ğŸšª Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©</button>
  </div>
  <button class="btn-secondary" style="max-width:280px" onclick="showScreen('main-menu')">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
</div>

<!-- WAITING -->
<div id="waiting" class="screen">
  <div class="room-code-display">
    <div class="code-label">ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©</div>
    <div class="code-value" id="display-code">â€”</div>
    <div class="code-hint">Ø´Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ</div>
  </div>
  <div class="players-waiting">
    <div class="waiting-title">â³ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† Ø§Ù„Ù…Ù†Ø¶Ù…ÙˆÙ†</div>
    <div class="waiting-list" id="waiting-list"></div>
  </div>
  <div style="width:100%;max-width:440px;display:flex;flex-direction:column;gap:0.6rem">
    <button class="btn-primary" id="start-btn" onclick="startGame()" style="display:none">âš”ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
    <div id="waiting-hint" class="pulse" style="color:var(--text-muted);font-size:0.85rem;text-align:center">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†...</div>
    <button class="btn-secondary" onclick="leaveRoom()">â† Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>
</div>

<!-- GAME -->
<div id="game" class="screen">
  <div class="top-bar">
    <div class="top-title">COUP</div>
    <div class="top-info">Ø¯ÙˆØ± <span id="top-turn">1</span> Â· Ø¬ÙˆÙ„Ø© <span id="top-round">1</span></div>
    <button class="btn-secondary" style="padding:0.4rem 0.75rem;font-size:0.75rem" onclick="showRules()">ğŸ“œ</button>
  </div>
  <div class="my-hand">
    <div class="hand-label">ğŸƒ Ø¨Ø·Ø§Ù‚Ø§ØªÙƒ â€” <span id="my-name-label">Ø£Ù†Øª</span></div>
    <div class="hand-cards" id="my-hand-cards"></div>
  </div>
  <div class="others-area" id="others-area"></div>
  <div class="ref-panel">
    <div class="ref-label">ğŸ“– Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø´Ø®ØµÙŠØ§Øª</div>
    <div class="ref-row" id="ref-row"></div>
  </div>
  <div class="actions-panel">
    <div class="actions-header">
      <div class="ah-left">
        <div class="ah-label">Ø¯ÙˆØ± Ø§Ù„Ù„Ø§Ø¹Ø¨</div>
        <div class="ah-name" id="ah-name">â€”</div>
      </div>
      <div class="ah-right">
        <div class="ah-label" style="text-align:left">ÙƒÙˆÙŠÙ†Ø²</div>
        <div class="ah-coins" id="ah-coins">â€”</div>
      </div>
    </div>
    <div id="actions-content"></div>
    <div class="target-area" id="target-area"></div>
  </div>
  <div class="log-panel">
    <div class="log-title">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</div>
    <div id="game-log"></div>
  </div>
</div>

<!-- WINNER -->
<div id="winner" class="screen">
  <div class="winner-scene">
    <div class="confetti">ğŸ‰</div><div class="confetti">âœ¨</div>
    <div class="confetti">ğŸŠ</div><div class="confetti">â­</div><div class="confetti">ğŸ’«</div>
    <div class="winner-crown">ğŸ‘‘</div>
    <div class="winner-label">Ø§Ù„ÙØ§Ø¦Ø² Ø¨Ø§Ù„Ø§Ù†Ù‚Ù„Ø§Ø¨</div>
    <div class="winner-name" id="winner-name-display">â€”</div>
    <div class="divider"></div>
  </div>
  <button class="btn-primary" style="max-width:280px" onclick="leaveRoom()">ğŸ”„ Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
</div>

<!-- CREDITS BAR -->
<div class="credits-bar">
  <span class="cr-label">Ø§Ù„Ù…Ù†ÙØ°ÙˆÙ†</span>
  <span class="cr-name">âš”ï¸ Abu Essam</span>
  <span class="cr-sep">âœ¦</span>
  <span class="cr-name">ğŸ¯ Turki</span>
</div>

<script type="module">
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIREBASE CONFIG â€” coup-f2869
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyCzWyErISamY0qQUZcBOMl85ymv-hZ464Y",
  authDomain: "coup-aa5be.firebaseapp.com",
  databaseURL: "https://coup-aa5be-default-rtdb.firebaseio.com",
  projectId: "coup-aa5be",
  storageBucket: "coup-aa5be.firebasestorage.app",
  messagingSenderId: "739144126475",
  appId: "1:739144126475:web:cd489183defa322e3af70e",
  measurementId: "G-SRQ2HETPV3"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARTICLES ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function initParticles() {
  const canvas = document.getElementById('particles-canvas');
  const ctx = canvas.getContext('2d');
  let W, H, particles = [];
  function resize() { W=canvas.width=window.innerWidth; H=canvas.height=window.innerHeight; }
  resize(); window.addEventListener('resize', resize);
  class Particle {
    constructor() { this.reset(); }
    reset() {
      this.x = Math.random()*W; this.y = Math.random()*H;
      this.r = Math.random()*1.5+0.3;
      this.vx = (Math.random()-0.5)*0.15; this.vy = (Math.random()-0.5)*0.15;
      this.alpha = Math.random()*0.25+0.05;
      this.color = Math.random()>0.6 ? `rgba(201,168,76,${this.alpha})` : `rgba(139,26,26,${this.alpha})`;
    }
    update() {
      this.x+=this.vx; this.y+=this.vy;
      if(this.x<0||this.x>W||this.y<0||this.y>H) this.reset();
    }
    draw() {
      ctx.beginPath(); ctx.arc(this.x,this.y,this.r,0,Math.PI*2);
      ctx.fillStyle=this.color; ctx.fill();
    }
  }
  for(let i=0;i<60;i++) particles.push(new Particle());
  function loop() {
    ctx.clearRect(0,0,W,H);
    particles.forEach(p=>{ p.update(); p.draw(); });
    requestAnimationFrame(loop);
  }
  loop();
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FX HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnFx(emoji, x, y) {
  const el = document.createElement('div');
  el.className = 'fx-splash'; el.textContent = emoji;
  el.style.left = (x||window.innerWidth/2) + 'px';
  el.style.top  = (y||window.innerHeight/2) + 'px';
  document.body.appendChild(el);
  setTimeout(()=>el.remove(), 900);
}
function coupFlash() {
  const el = document.createElement('div'); el.className='coup-flash';
  document.body.appendChild(el); setTimeout(()=>el.remove(), 600);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CHARS = {
  duke:       { name:'Duke',       icon:'ğŸ’œ', color:'duke',       actions:['Ø¬Ù…Ø¹ 3 ÙƒÙˆÙŠÙ†Ø² (Tax)','ÙŠÙ…Ù†Ø¹ Foreign Aid'], blocks:['foreign_aid'] },
  assassin:   { name:'Assassin',   icon:'ğŸ—¡ï¸', color:'assassin',   actions:['ÙŠØºØªØ§Ù„ Ø¨Ù€ 3 ÙƒÙˆÙŠÙ†Ø²'],                   blocks:[] },
  ambassador: { name:'Ambassador', icon:'ğŸ•Šï¸', color:'ambassador', actions:['ÙŠØ³ØªØ¨Ø¯Ù„ ÙƒØ±ÙˆØªÙ‡','ÙŠÙ…Ù†Ø¹ Steal'],            blocks:['steal'] },
  captain:    { name:'Captain',    icon:'âš“', color:'captain',    actions:['ÙŠØ³Ø±Ù‚ 2 ÙƒÙˆÙŠÙ†Ø²','ÙŠÙ…Ù†Ø¹ Steal'],           blocks:['steal'] },
  contessa:   { name:'Contessa',   icon:'ğŸŒ¹', color:'contessa',   actions:['ØªÙ…Ù†Ø¹ Assassinate'],                     blocks:['assassinate'] }
};

const ACTIONS = [
  { id:'income',      name:'Income',      icon:'ğŸ’°', desc:'+1 ÙƒÙˆÙŠÙ†ØŒ Ù„Ø§ ÙŠÙØ¹Ø·ÙÙ‘Ù„',          type:'income',           cost:0, gain:1, needsTarget:false, char:null },
  { id:'foreign_aid', name:'Foreign Aid', icon:'ğŸ¤', desc:'+2 ÙƒÙˆÙŠÙ†ØŒ Duke ÙŠÙ…Ù†Ø¹Ù‡',           type:'foreign-aid',      cost:0, gain:2, needsTarget:false, char:null },
  { id:'coup',        name:'Coup',        icon:'ğŸ’¥', desc:'Ø£Ø¬Ø¨Ø± Ù„Ø§Ø¹Ø¨Ù‹Ø§ Ø¹Ù„Ù‰ ÙƒØ´Ù ÙƒØ±Øª',       type:'coup-action',      cost:7, gain:0, needsTarget:true,  char:null },
  { id:'tax',         name:'Tax (Duke)',  icon:'ğŸ’œ', desc:'+3 ÙƒÙˆÙŠÙ†Ø²',                      type:'duke-action',      cost:0, gain:3, needsTarget:false, char:'duke' },
  { id:'assassinate', name:'Assassinate', icon:'ğŸ—¡ï¸', desc:'Ø§ØºØªÙ„ Ù„Ø§Ø¹Ø¨Ù‹Ø§ Ø¨Ù€ 3 ÙƒÙˆÙŠÙ†Ø²',       type:'assassin-action',  cost:3, gain:0, needsTarget:true,  char:'assassin' },
  { id:'steal',       name:'Steal',       icon:'âš“', desc:'Ø§Ø³Ø±Ù‚ 2 ÙƒÙˆÙŠÙ†Ø² Ù…Ù† Ù„Ø§Ø¹Ø¨',         type:'captain-action',   cost:0, gain:0, needsTarget:true,  char:'captain' },
  { id:'exchange',    name:'Exchange',    icon:'ğŸ•Šï¸', desc:'Ø§Ø³ØªØ¨Ø¯Ù„ ÙƒØ±ÙˆØªÙƒ Ù…Ù† Ø§Ù„ÙƒÙˆÙ…Ø©',        type:'ambassador-action',cost:0, gain:0, needsTarget:false, char:'ambassador' },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOCAL STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let myId = null, myName = '', roomCode = '', isHost = false, roomRef = null, currentAction = null, volume = 70;

// SETTINGS
document.getElementById('volume-slider').addEventListener('input', e => {
  volume = parseInt(e.target.value);
  document.getElementById('volume-value').textContent = volume + '%';
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genCode() {
  const c = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  return Array.from({length:4}, () => c[Math.floor(Math.random()*c.length)]).join('');
}
function shuffle(arr) {
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}
  return a;
}
function buildDeck() {
  const deck=[];
  Object.keys(CHARS).forEach(c=>{ for(let i=0;i<3;i++) deck.push(c); });
  return shuffle(deck);
}
window.showNotif = function(msg) {
  const n=document.createElement('div'); n.className='notif'; n.textContent=msg;
  document.body.appendChild(n); setTimeout(()=>n.remove(),3000);
}
window.showScreen = function(id) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
window.closeModals = function() {
  document.querySelectorAll('.modal-overlay').forEach(m=>m.remove());
}
function mkModal() {
  const overlay=document.createElement('div'); overlay.className='modal-overlay';
  overlay.onclick=e=>{ if(e.target===overlay) window.closeModals(); };
  const modal=document.createElement('div'); modal.className='modal';
  overlay.appendChild(modal); return modal;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOBBY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupListener() {
  onValue(roomRef, snapshot => {
    const data = snapshot.val();
    if (!data) return;
    if (data.status === 'waiting') {
      renderWaiting(data);
    } else if (data.status === 'playing') {
      renderGame(data);
      if (document.getElementById('waiting').classList.contains('active')) {
        showScreen('game'); buildRefCards();
      }
    } else if (data.status === 'finished') {
      document.getElementById('winner-name-display').textContent = data.winner || '?';
      showScreen('winner');
      // Launch fireworks
      setTimeout(()=>{ spawnFx('ğŸ‘‘',window.innerWidth/2,window.innerHeight/3); },200);
      setTimeout(()=>{ spawnFx('ğŸ‰',window.innerWidth*0.2,window.innerHeight*0.4); },400);
      setTimeout(()=>{ spawnFx('âœ¨',window.innerWidth*0.8,window.innerHeight*0.4); },600);
    }
    checkPendingActions(data);
  });
}

window.createRoom = async function() {
  let name = document.getElementById('player-name-input').value.trim() || 'Ù„Ø§Ø¹Ø¨';
  myName=name; isHost=true; myId=0; roomCode=genCode();
  const room = {
    code:roomCode, host:0, status:'waiting',
    players:[{id:0,name,coins:2,cards:[],cardRevealed:[false,false],eliminated:false}],
    deck:[], currentPlayer:0, turn:1, round:1, log:[], pendingBlock:null, pendingReveal:null
  };
  roomRef=ref(db,`rooms/${roomCode}`);
  await set(roomRef,room);
  document.getElementById('display-code').textContent=roomCode;
  showScreen('waiting');
  setupListener();
}

window.joinRoom = async function() {
  let name = document.getElementById('player-name-input').value.trim() || 'Ù„Ø§Ø¹Ø¨';
  const code = document.getElementById('room-code-input').value.trim().toUpperCase();
  if (!code||code.length!==4) { showNotif('Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© (4 Ø£Ø­Ø±Ù)'); return; }
  myName=name; roomCode=code; isHost=false;
  roomRef=ref(db,`rooms/${roomCode}`);
  const snapshot=await get(roomRef);
  if (!snapshot.exists()) { showNotif('Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©!'); return; }
  const room=snapshot.val();
  if (room.status!=='waiting') { showNotif('Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø¯Ø£Øª Ø¨Ø§Ù„ÙØ¹Ù„!'); return; }
  if (room.players.length>=6) { showNotif('Ø§Ù„ØºØ±ÙØ© Ù…Ù…ØªÙ„Ø¦Ø©!'); return; }
  const existing=room.players.find(p=>p.name===name);
  if (existing) { myId=existing.id; }
  else {
    myId=room.players.length;
    room.players.push({id:myId,name,coins:2,cards:[],cardRevealed:[false,false],eliminated:false});
    await set(roomRef,room);
  }
  document.getElementById('display-code').textContent=roomCode;
  showScreen('waiting');
  setupListener();
}

window.startGame = async function() {
  if (!isHost) return;
  const snapshot=await get(roomRef); if (!snapshot.exists()) return;
  const room=snapshot.val();
  if (room.players.length<2) { showNotif('ØªØ­ØªØ§Ø¬ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!'); return; }
  room.deck=buildDeck();
  room.players.forEach(p=>{
    p.cards=[room.deck.pop(),room.deck.pop()];
    p.cardRevealed=[false,false]; p.coins=2; p.eliminated=false;
  });
  room.currentPlayer=0; room.turn=1; room.round=1;
  room.log=[`âš”ï¸ Ø¨Ø¯Ø£Øª Ø§Ù„Ù„Ø¹Ø¨Ø©! ${room.players.length} Ù„Ø§Ø¹Ø¨ÙŠÙ†.`];
  room.status='playing';
  await set(roomRef,room);
}

window.leaveRoom = function() {
  roomCode=''; myId=null; myName=''; isHost=false; roomRef=null;
  showScreen('main-menu');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WAITING RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderWaiting(room) {
  document.getElementById('waiting-list').innerHTML=room.players.map((p,i)=>`
    <div class="waiting-player">
      <div class="waiting-dot"></div>
      <div class="waiting-name">${p.name}</div>
      ${i===0?'<div class="waiting-host">Host</div>':''}
    </div>`).join('');
  const startBtn=document.getElementById('start-btn');
  const hint=document.getElementById('waiting-hint');
  if (isHost&&room.players.length>=2) { startBtn.style.display='block'; hint.style.display='none'; }
  else if (isHost) { startBtn.style.display='none'; hint.textContent='ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø§Ø¹Ø¨ Ø¢Ø®Ø±...'; hint.style.display='block'; }
  else { startBtn.style.display='none'; hint.textContent=`ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± ${room.players[0].name} Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©...`; hint.style.display='block'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGame(room) {
  const me=room.players[myId]; if (!me) return;
  document.getElementById('top-turn').textContent=room.turn;
  document.getElementById('top-round').textContent=room.round;
  document.getElementById('my-name-label').textContent=me.name;

  // â”€â”€ My hand (spectator sees dimmed cards) â”€â”€
  const isSpectator = me.eliminated;
  document.getElementById('my-hand-cards').innerHTML=me.cards.map((c,i)=>{
    const ch=CHARS[c]; const rev=me.cardRevealed[i];
    return `<div class="hand-card ${ch.color} ${rev?'revealed':''}" style="${isSpectator?'opacity:0.3;filter:grayscale(1)':''}">
      <div class="hc-icon">${ch.icon}</div><div class="hc-name">${ch.name}</div>
      ${rev?'<span style="font-size:0.6rem;opacity:0.6">Ù…ÙƒØ´ÙˆÙ</span>':''}
    </div>`;
  }).join('');

  document.getElementById('others-area').innerHTML=room.players.filter(p=>p.id!==myId).map(p=>{
    const isCurrent=p.id===room.currentPlayer;
    return `<div class="opp-card ${isCurrent?'active-turn':''} ${p.eliminated?'eliminated':''}">
      <div class="opp-header"><div class="opp-name">${isCurrent?'â–¶ ':''}${p.name}${p.eliminated?' ğŸ’€':''}</div><div class="opp-coins">ğŸ’° ${p.coins}</div></div>
      <div class="opp-cards-row">${p.cards.map((c,i)=>{
        if (p.cardRevealed[i]) { const ch=CHARS[c]; return `<div class="mini-card ${ch.color}" style="position:relative"><div class="dead-badge">âœ•</div><div class="mc-icon">${ch.icon}</div><div style="font-size:0.5rem">${ch.name}</div></div>`; }
        return `<div class="mini-card face-down"></div>`;
      }).join('')}</div>
    </div>`;
  }).join('');

  const curP=room.players[room.currentPlayer];
  document.getElementById('ah-name').textContent=curP.name;
  document.getElementById('ah-coins').textContent=`ğŸ’° ${curP.coins}`;

  const isMyTurn=room.currentPlayer===myId&&!isSpectator;
  let actionsHTML;
  if (isSpectator) {
    actionsHTML=`<div class="spectator-banner">
      <div class="spec-icon">ğŸ‘ï¸</div>
      <div class="spec-text">
        <div class="spec-title">Ø£Ù†Øª Ø§Ù„Ø¢Ù† ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</div>
        <div class="spec-sub">Ø®Ø±Ø¬Øª Ù…Ù† Ø§Ù„Ù„Ø¹Ø¨Ø© â€” Ø´Ø§Ù‡Ø¯ ÙƒÙŠÙ ØªØªØ·ÙˆØ± Ø§Ù„Ø£Ù…ÙˆØ±!</div>
      </div>
    </div>`;
  } else if (isMyTurn) {
    actionsHTML=renderActionsGrid(me,room);
  } else {
    actionsHTML=`<div class="waiting-turn">â³ Ø¯ÙˆØ± <span class="wt-name">${curP.name}</span>...</div>`;
  }
  document.getElementById('actions-content').innerHTML=actionsHTML;
  document.getElementById('target-area').innerHTML='';
  document.getElementById('game-log').innerHTML=[...room.log].reverse().slice(0,30).map((msg,i)=>`
    <div class="log-entry"><div class="log-t">${Math.max(1,room.turn-i)}</div><div class="log-m">${msg}</div></div>`).join('');
}

function renderActionsGrid(me,room) {
  return `<div class="actions-grid">`+ACTIONS.map(a=>{
    const mustCoup=me.coins>=10&&a.id!=='coup';
    const cantCoup=a.id==='coup'&&me.coins<7;
    const cantAss=a.id==='assassinate'&&me.coins<3;
    const disabled=mustCoup||cantCoup||cantAss;
    const required=a.id==='coup'&&me.coins>=10;
    let costHtml='';
    if (a.cost>0) costHtml=`<div class="ab-cost">ğŸ’° ${a.cost}</div>`;
    if (a.gain>0) costHtml=`<div class="ab-cost gain">+${a.gain} ğŸ’°</div>`;
    return `<button class="action-btn ${a.type} ${required?'required':''}" ${disabled?'disabled':''} onclick="window.handleAction('${a.id}')">
      <div class="ab-top"><div class="ab-name">${a.name}</div><div class="ab-icon">${a.icon}</div></div>
      ${costHtml}<div class="ab-desc">${a.desc}</div>
    </button>`;
  }).join('')+`</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.handleAction = async function(actionId) {
  const snapshot=await get(roomRef); if (!snapshot.exists()) return;
  const room=snapshot.val(); if (room.currentPlayer!==myId) return;
  const action=ACTIONS.find(a=>a.id===actionId); if (!action) return;
  if (action.needsTarget) { currentAction=action; showTargetPicker(action,room); return; }
  await submitAction(action,null);
}

function showTargetPicker(action,room) {
  const targets=room.players.filter(p=>p.id!==myId&&!p.eliminated);
  document.getElementById('target-area').innerHTML=`<div class="target-box">
    <div class="target-label">ğŸ¯ Ø§Ø®ØªØ± Ù‡Ø¯ÙÙƒ:</div>
    <div class="target-btns">${targets.map(t=>`<button class="target-btn" onclick="window.selectTarget(${t.id})">${t.name} (ğŸ’°${t.coins})</button>`).join('')}</div>
  </div>`;
}

window.selectTarget = async function(targetId) {
  if (!currentAction) return;
  await submitAction(currentAction,targetId); currentAction=null;
}

window.submitAction = async function(action,targetId) {
  document.getElementById('target-area').innerHTML='';
  const snapshot=await get(roomRef); if (!snapshot.exists()) return;
  const room=snapshot.val();
  const me=room.players[myId];
  const target=targetId!==null?room.players[targetId]:null;
  const blockable=['foreign_aid','tax','assassinate','steal','exchange'];
  if (blockable.includes(action.id)) {
    room.pendingBlock={actionId:action.id,actorId:myId,targetId,timestamp:Date.now(),blocked:false,challenged:false,blockerChar:null};
    room.log.unshift(`âš¡ <span class="hl">${me.name}</span> ÙŠØ­Ø§ÙˆÙ„: <span class="hl">${action.name}</span>${target?' Ø¹Ù„Ù‰ '+target.name:''} â€” Ù‡Ù„ ÙŠØ¹ØªØ±Ø¶ Ø£Ø­Ø¯ØŸ`);
    await set(roomRef,room);
    setTimeout(async()=>{
      const s2=await get(roomRef); if (!s2.exists()) return;
      await resolveAction(s2.val(),action,targetId);
    },10000);
    return;
  }
  await applyAction(room,action,me,target);
}

async function resolveAction(room,action,targetId) {
  const pb=room.pendingBlock; if (!pb||pb.actionId!==action.id) return;
  const me=room.players[pb.actorId];
  const target=pb.targetId!==null?room.players[pb.targetId]:null;
  if (pb.blocked) {
    const bch=CHARS[pb.blockerChar];
    room.log.unshift(`ğŸ›¡ï¸ ØªÙ… ØªØ¹Ø·ÙŠÙ„ <span class="hl">${action.name}</span> Ø¨Ù€ ${bch.icon} ${bch.name}!`);
    if (action.id==='assassinate') me.coins+=3;
    room.pendingBlock=null; await advanceTurn(room); return;
  }
  if (pb.challenged) {
    const hasCard=action.char&&me.cards.some((c,i)=>c===action.char&&!me.cardRevealed[i]);
    if (!hasCard&&action.char) {
      room.log.unshift(`â“ Ø§Ù„ØªØ´ÙƒÙŠÙƒ Ù†Ø¬Ø­! ${me.name} Ù„Ø§ ÙŠÙ…Ù„Ùƒ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø²Ø¹ÙˆÙ…Ø©.`);
      const idx=me.cards.findIndex((_,i)=>!me.cardRevealed[i]);
      if (idx>=0) me.cardRevealed[idx]=true;
      checkElimination(room,me);
      if (action.id==='assassinate') me.coins+=3;
      room.pendingBlock=null; await advanceTurn(room); return;
    } else {
      room.log.unshift(`â“ Ø§Ù„ØªØ´ÙƒÙŠÙƒ ÙØ´Ù„! ${me.name} Ø£Ø«Ø¨Øª Ø§Ø¯Ø¹Ø§Ø¡Ù‡.`);
      if (pb.challengerId!==undefined) {
        const challenger=room.players[pb.challengerId];
        const idx=challenger.cards.findIndex((_,i)=>!challenger.cardRevealed[i]);
        if (idx>=0) challenger.cardRevealed[idx]=true;
        checkElimination(room,challenger);
      }
    }
  }
  room.pendingBlock=null; await applyAction(room,action,me,target);
}

async function applyAction(room,action,me,target) {
  switch(action.id) {
    case 'income':
      me.coins+=1; spawnFx('ğŸ’°');
      room.log.unshift(`ğŸ’° <span class="hl">${me.name}</span> Ø¬Ù…Ø¹ Income (+1). Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span class="coin-c">${me.coins}</span>`); break;
    case 'foreign_aid':
      me.coins+=2; spawnFx('ğŸ¤');
      room.log.unshift(`ğŸ¤ <span class="hl">${me.name}</span> Ø­ØµÙ„ Ø¹Ù„Ù‰ Foreign Aid (+2). Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span class="coin-c">${me.coins}</span>`); break;
    case 'coup':
      if (me.coins<7) return; me.coins-=7; coupFlash(); spawnFx('ğŸ’¥');
      room.log.unshift(`ğŸ’¥ <span class="hl">${me.name}</span> Ù†ÙØ° Coup Ø¹Ù„Ù‰ <span class="danger-c">${target.name}</span>!`);
      room.pendingReveal={targetId:target.id}; await set(roomRef,room); return;
    case 'tax':
      me.coins+=3; spawnFx('ğŸ’œ');
      room.log.unshift(`ğŸ’œ <span class="hl">${me.name}</span> Ø¬Ù…Ø¹ Tax (Duke +3). Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span class="coin-c">${me.coins}</span>`); break;
    case 'assassinate':
      if (me.coins<3) return; me.coins-=3; coupFlash(); spawnFx('ğŸ—¡ï¸');
      room.log.unshift(`ğŸ—¡ï¸ <span class="hl">${me.name}</span> Ø§ØºØªØ§Ù„ <span class="danger-c">${target.name}</span>!`);
      room.pendingReveal={targetId:target.id}; await set(roomRef,room); return;
    case 'steal': {
      const stolen=Math.min(2,target.coins); target.coins-=stolen; me.coins+=stolen; spawnFx('âš“');
      room.log.unshift(`âš“ <span class="hl">${me.name}</span> Ø³Ø±Ù‚ <span class="coin-c">${stolen}</span> ÙƒÙˆÙŠÙ†Ø² Ù…Ù† <span class="danger-c">${target.name}</span>!`); break;
    }
    case 'exchange': {
      const drawn=[];
      if (room.deck.length>0) drawn.push(room.deck.pop());
      if (room.deck.length>0) drawn.push(room.deck.pop());
      const live=me.cards.filter((_,i)=>!me.cardRevealed[i]);
      const pool=[...live,...drawn]; const kept=pool.slice(0,live.length);
      pool.slice(live.length).forEach(c=>room.deck.unshift(c));
      room.deck=shuffle(room.deck); let ki=0;
      me.cards=me.cards.map((c,i)=>me.cardRevealed[i]?c:kept[ki++]);
      spawnFx('ğŸ•Šï¸');
      room.log.unshift(`ğŸ•Šï¸ <span class="hl">${me.name}</span> Ø§Ø³ØªØ¨Ø¯Ù„ ÙƒØ±ÙˆØªÙ‡ (Ambassador).`); break;
    }
  }
  await advanceTurn(room);
}

async function advanceTurn(room) {
  const winner=checkWinner(room);
  if (winner) { room.status='finished'; room.winner=winner.name; await set(roomRef,room); return; }
  let next=(room.currentPlayer+1)%room.players.length, tries=0;
  while (room.players[next].eliminated&&tries<room.players.length) { next=(next+1)%room.players.length; tries++; }
  if (next<=room.currentPlayer) room.round++;
  room.currentPlayer=next; room.turn++;
  await set(roomRef,room);
}

function checkElimination(room,player) {
  if (player.cardRevealed.every(r=>r)) {
    player.eliminated=true;
    room.log.unshift(`ğŸ’€ <span class="danger-c">${player.name}</span> ØªÙ… Ø§Ù„Ù‚Ø¶Ø§Ø¡ Ø¹Ù„ÙŠÙ‡!`);
    if (player.id===myId) {
      // will show spectator banner on next render
      setTimeout(()=>{ spawnFx('ğŸ’€',window.innerWidth/2,window.innerHeight/3); },300);
    }
  }
}
function checkWinner(room) {
  const alive=room.players.filter(p=>!p.eliminated);
  return alive.length===1?alive[0]:null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PENDING ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let shownBlockTs=0, shownRevealTs=0;

function checkPendingActions(room) {
  if (room.status!=='playing') return;
  if (room.pendingReveal&&room.pendingReveal.targetId===myId) {
    if (shownRevealTs!==room.pendingReveal.targetId) {
      shownRevealTs=room.pendingReveal.targetId; showRevealModal(room);
    }
  }
  const pb=room.pendingBlock;
  if (pb&&pb.actorId!==myId&&!pb.blocked&&!pb.challenged) {
    if (Date.now()-pb.timestamp<10000) {
      if (shownBlockTs!==pb.timestamp) {
        shownBlockTs=pb.timestamp;
        const action=ACTIONS.find(a=>a.id===pb.actionId);
        const actor=room.players[pb.actorId];
        const target=pb.targetId!==null?room.players[pb.targetId]:null;
        const isTarget=target&&target.id===myId;
        showBlockWindow(pb,action,actor,target,isTarget);
      }
    }
  }
}

function showBlockWindow(pb,action,actor,target,isTarget) {
  const modal=mkModal(); const blockers=getBlockers(pb.actionId);
  let blockBtns='';
  if (isTarget&&blockers.length>0) {
    blockBtns=blockers.map(b=>`
      <button class="mbtn danger" onclick="window.doBlock('${b.char}')">
        <span class="mi">${CHARS[b.char].icon}</span>
        <div class="mt"><div class="mn">Block with ${CHARS[b.char].name}</div><div class="md">ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</div></div>
      </button>`).join('');
  }
  if (pb.actionId==='assassinate'&&isTarget) {
    blockBtns+=`<button class="mbtn danger" onclick="window.doBlock('contessa')">
      <span class="mi">ğŸŒ¹</span><div class="mt"><div class="mn">Block with Contessa</div><div class="md">Ø£Ù…Ù†Ø¹ Ø§Ù„Ø§ØºØªÙŠØ§Ù„</div></div>
    </button>`;
  }
  modal.innerHTML=`
    <div class="modal-title">âš¡ ${actor.name} ÙŠØ­Ø§ÙˆÙ„ ${action.name}!</div>
    <div class="modal-sub">${target?'Ø§Ù„Ù‡Ø¯Ù: '+target.name:''} â€” Ù„Ø¯ÙŠÙƒ 10 Ø«ÙˆØ§Ù†Ù</div>
    <div class="modal-btns">
      <button class="mbtn confirm" onclick="window.closeModals()">
        <span class="mi">âœ…</span><div class="mt"><div class="mn">Ù„Ø§ Ø§Ø¹ØªØ±Ø§Ø¶</div><div class="md">Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</div></div>
      </button>
      ${blockBtns}
      <button class="mbtn danger" onclick="window.doChallenge()">
        <span class="mi">â“</span><div class="mt"><div class="mn">ØªØ´ÙƒÙŠÙƒ!</div><div class="md">Ø£Ø´Ùƒ ÙÙŠ Ø§Ø¯Ø¹Ø§Ø¦Ù‡</div></div>
      </button>
    </div>
    <div class="timer-bar"></div>`;
  document.body.appendChild(modal.parentElement);
}

window.doBlock = async function(charKey) {
  closeModals();
  const snapshot=await get(roomRef); if (!snapshot.exists()) return;
  const room=snapshot.val(); if (!room.pendingBlock) return;
  room.pendingBlock.blocked=true; room.pendingBlock.blockerChar=charKey;
  await set(roomRef,room);
}

window.doChallenge = async function() {
  closeModals();
  const snapshot=await get(roomRef); if (!snapshot.exists()) return;
  const room=snapshot.val(); if (!room.pendingBlock) return;
  room.pendingBlock.challenged=true; room.pendingBlock.challengerId=myId;
  await set(roomRef,room);
}

function getBlockers(actionId) {
  if (actionId==='foreign_aid') return [{char:'duke'}];
  if (actionId==='steal') return [{char:'ambassador'},{char:'captain'}];
  return [];
}

function showRevealModal(room) {
  const me=room.players[myId];
  const idxArr=me.cardRevealed.map((r,i)=>r?-1:i).filter(i=>i>=0);
  if (idxArr.length===0) return;
  const modal=mkModal();
  modal.innerHTML=`
    <div class="modal-title">ğŸ’€ Ø¹Ù„ÙŠÙƒ ÙƒØ´Ù Ø¨Ø·Ø§Ù‚Ø©!</div>
    <div class="modal-sub">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªÙŠ Ø³ØªÙƒØ´ÙÙ‡Ø§</div>
    <div class="modal-btns">
      ${idxArr.map(i=>{
        const ch=CHARS[me.cards[i]];
        return `<button class="mbtn danger" onclick="window.revealMyCard(${i})">
          <span class="mi">${ch.icon}</span><div class="mt"><div class="mn">${ch.name}</div><div class="md">ÙƒØ´Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</div></div>
        </button>`;
      }).join('')}
    </div>`;
  document.body.appendChild(modal.parentElement);
}

window.revealMyCard = async function(cardIdx) {
  closeModals();
  const snapshot=await get(roomRef); if (!snapshot.exists()) return;
  const room=snapshot.val(); const me=room.players[myId];
  me.cardRevealed[cardIdx]=true;
  room.log.unshift(`â˜ ï¸ <span class="danger-c">${me.name}</span> ÙÙ‚Ø¯ ${CHARS[me.cards[cardIdx]].icon} ${CHARS[me.cards[cardIdx]].name}!`);
  checkElimination(room,me); room.pendingReveal=null;
  await advanceTurn(room);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REF CARDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildRefCards() {
  const row=document.getElementById('ref-row');
  if (!row||row.innerHTML) return;
  row.innerHTML=Object.entries(CHARS).map(([k,c])=>`
    <div class="ref-chip ${c.color}" onclick="window.showCharInfo('${k}')">
      <div class="rc-icon">${c.icon}</div><div class="rc-name">${c.name}</div><div class="rc-power">${c.actions[0]}</div>
    </div>`).join('');
}

window.showCharInfo = function(k) {
  const c=CHARS[k]; const modal=mkModal();
  modal.innerHTML=`
    <div style="text-align:center;margin-bottom:1rem"><div style="font-size:3rem">${c.icon}</div><div class="modal-title">${c.name}</div></div>
    <div style="background:var(--bg-surface);border-radius:10px;padding:1rem;margin-bottom:1rem;font-size:0.83rem">
      <div style="color:var(--gold);font-weight:700;margin-bottom:0.4rem">âš¡ Ø§Ù„Ù‚Ø¯Ø±Ø§Øª:</div>
      ${c.actions.map(a=>`<div style="color:var(--text-muted);margin-bottom:0.2rem">â€¢ ${a}</div>`).join('')}
      ${c.blocks.length?`<div style="color:var(--gold);font-weight:700;margin:0.4rem 0">ğŸ›¡ï¸ ÙŠØ­Ø¬Ø¨:</div>${c.blocks.map(b=>`<div style="color:var(--text-muted)">â€¢ ${ACTIONS.find(a=>a.id===b)?.name||b}</div>`).join('')}`:''}
    </div>
    <button class="mbtn" onclick="window.closeModals()" style="width:100%;justify-content:center">Ø¥ØºÙ„Ø§Ù‚</button>`;
  document.body.appendChild(modal.parentElement);
}

window.showRules = function() {
  const modal=mkModal();
  modal.innerHTML=`
    <div class="modal-title">ğŸ“œ Ù‚ÙˆØ§Ø¹Ø¯ Coup</div>
    <div style="font-size:0.8rem;color:var(--text-muted);line-height:1.8;max-height:60vh;overflow-y:auto;margin-bottom:1rem">
      <b style="color:var(--gold-light)">ğŸ¯ Ø§Ù„Ù‡Ø¯Ù:</b> ÙƒÙ† Ø¢Ø®Ø± Ù„Ø§Ø¹Ø¨ ÙŠÙ…Ù„Ùƒ Ø¨Ø·Ø§Ù‚Ø© Ø­ÙŠØ©.<br><br>
      <b style="color:var(--gold-light)">ğŸƒ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©:</b> ÙƒÙ„ Ù„Ø§Ø¹Ø¨ ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 2 Ø¨Ø·Ø§Ù‚Ø§Øª Ùˆ 2 ÙƒÙˆÙŠÙ†Ø² Ø³Ø±ÙŠØ©.<br><br>
      <b style="color:var(--gold-light)">âš¡ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª:</b><br>
      â€¢ Income: +1 ÙƒÙˆÙŠÙ†. Ù„Ø§ ÙŠÙØ¹Ø·ÙÙ‘Ù„.<br>â€¢ Foreign Aid: +2ØŒ Duke ÙŠÙ…Ù†Ø¹Ù‡.<br>
      â€¢ Coup: 7 ÙƒÙˆÙŠÙ†Ø²ØŒ Ù„Ø§ ÙŠÙØ¹Ø·ÙÙ‘Ù„.<br>â€¢ Tax (Duke): +3 ÙƒÙˆÙŠÙ†.<br>
      â€¢ Assassinate: 3 ÙƒÙˆÙŠÙ†Ø²ØŒ Contessa ØªÙ…Ù†Ø¹Ù‡.<br>â€¢ Steal (Captain): Ø§Ø³Ø±Ù‚ 2ØŒ Ambassador/Captain ÙŠÙ…Ù†Ø¹Ø§Ù†Ù‡.<br>
      â€¢ Exchange (Ambassador): Ø§Ø³ØªØ¨Ø¯Ù„ ÙƒØ±ÙˆØªÙƒ.<br><br>
      <b style="color:var(--gold-light)">â“ Ø§Ù„ØªØ´ÙƒÙŠÙƒ ÙˆØ§Ù„Ø­Ø¬Ø¨:</b><br>
      Ø¹Ù†Ø¯ Ø¥Ø¬Ø±Ø§Ø¡ Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø­Ø¬Ø¨ØŒ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† Ø§Ù„Ø¢Ø®Ø±ÙˆÙ† Ù„Ø¯ÙŠÙ‡Ù… 10 Ø«ÙˆØ§Ù†Ù Ù„Ù„Ø§Ø¹ØªØ±Ø§Ø¶.<br><br>
      <b style="color:var(--gold-light)">âš ï¸ 10 ÙƒÙˆÙŠÙ†Ø²:</b> ÙŠØ¬Ø¨ ØªÙ†ÙÙŠØ° Coup.
    </div>
    <button class="mbtn" onclick="window.closeModals()" style="width:100%;justify-content:center">ÙÙ‡Ù…Øª ğŸ‘</button>`;
  document.body.appendChild(modal.parentElement);
}
</script>
</body>
</html>
